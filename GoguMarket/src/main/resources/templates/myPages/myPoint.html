<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://ultraq.net/thymeleaf/layout"
	layout:decorate="~{myPages/sideBar/sideBar}">
<head>
<meta charset="UTF-8">
<link rel="stylesheet" href="/css/myPages/myPoint.css">
</head>
<body>
	<div layout:fragment="myContent">
		<div class="container">
			<div class="message-box box-shadow white-bg"
				style="height: 750px; width: 100%">
				<div class="tab-pane active" id="order-complete">
					<div>
						<h4 class="blog-section-title border-left mb-30">λ‚μ ν¬μΈνΈ</h4>
					</div>
					<div class="order-complete-content box-shadow">
						<div class="order-info p-30 mb-10">
							<ul class="order-info-list">
								<li><a class="totalP" href='javascript:void(0);'
									onclick="criteriaPoint(event);">ν„μ¬ ν¬μΈνΈ</a>
									<p>
										μ΄ <span class="totalPTrgt"
											style="color: #C04A82; font-weight: bold;">0</span>ν¬μΈνΈ
									</p></li>
								<li><a class="attendP" href='javascript:void(0);'
									onclick="criteriaPoint(event);">μ¶μ„ν•κΈ°</a>
									<p>
										<span class="attendPTrgt">0</span>ν¬μΈνΈ
									</p></li>
								<li><a class="dealP" href='javascript:void(0);'
									onclick="criteriaPoint(event);">κ±°λν›„κΈ°</a>
									<p>
										<span class="dealPTrgt">0</span>ν¬μΈνΈ
									</p></li>
								<li><a class="freeP" href='javascript:void(0);'
									onclick="criteriaPoint(event);">λ¬΄λ£λ‚λ”</a>
									<p>
										<span class="freePTrgt">0</span>ν¬μΈνΈ
									</p></li>
								<li><a class="usedP">μ‚¬μ©μ™„λ£</a>
									<p>
										<span class="usedPTrgt">0</span>ν¬μΈνΈ
									</p></li>
							</ul>
						</div>
						<div class="row">
							<div class="col-md-6">
								<div class="payment-details p-30">
									<h6 class="widget-title border-left mb-20"
										style="display: inline-block;">
										<span style="color: #C04A82" id="ttlTrgt">μ „μ²΄</span> μ λ¦½ λ‚΄μ—­
									</h6>

									<button class="submit-btn-1 btn-hover-1"
										style="float: right; border-radius: 20px; height: 30px"
										id="usePointBtn">ν¬μΈνΈ μ‚¬μ©ν•κΈ°</button>
									<table class="saveTable">
									</table>
								</div>
							</div>
							<div class="col-md-6">
								<div class="payment-details p-30">
									<h6 class="widget-title border-left mb-20"
										style="display: inline-block;">ν¬μΈνΈ μ‚¬μ© λ‚΄μ—­</h6>
									<table class="usedTable">
									</table>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<script type="text/javascript">
	// ==============================================================
	// β¤οΈ μ „μ—­λ³€μ μ„ μ–Έ
		var pointInfo; // μ „μ²΄ ν¬μΈνΈ μ •λ³΄
		
   		var pointTotal = 0; // μ „μ²΄ μ΄ν•©
   		var attendPTotal = 0; // μ¶μ„ μ΄ν•©
   		var dealPTotal = 0; // κ±°λν›„κΈ° μ΄ν•©
   		var freePTotal = 0; // λ¬΄λ£λ‚λ” μ΄ν•©
   		var usedTotal = 0; // μ‚¬μ©μ™„λ£ μ΄ν•©
   		
   		var saveCnt = 0; // μ λ¦½ νμ
   		var usedCnt = 0; //μ‚¬μ© νμ
   		
   	// ==============================================================
   	// β¤οΈ DOM ν•¨μ
       $(function(){
    	  myPointAjax();
    	  
    	  $("#usePointBtn").on("click",function(){
    		  location = "/my/myDeal";
    	  })
       })
   		
    // ==============================================================
    // β¤οΈ νΉμ • ν¬μΈνΈλ§ μ¶λ ¥ 
    	function criteriaPoint(event){
   			let criteria = $(event.target).text();
   			$("#ttlTrgt").text(criteria); // π“ κµμλ‹ ν”Όλ“λ°± : μ‚¬μ©μκ°€ μ•κΈ° μ‰½κ² νƒ€μ΄ν‹€μ— ν‘μ‹ν•κΈ°
   			saveCnt = 0;
   			
			$(".saveTable").children().remove();
			
   			pointInfo.forEach((point, idx)=>{
   				if(point.pointMthd==criteria){
					makeSaveTable(point);
					saveCnt++;
   				}else if(criteria=='ν„μ¬ ν¬μΈνΈ' && point.pointMthd != 'λμ–΄μ¬λ¦¬κΈ°'){
   					$("#ttlTrgt").text('μ „μ²΄');
   					makeSaveTable(point);
   					saveCnt++;
   				}
   			})
   			
			if(saveCnt<1){
					$(".saveTable").append(
							`<tr>
					           <td class="td-title-1">${criteria} μ λ¦½ λ‚΄μ—­μ΄ μ—†μµλ‹λ‹¤.</td>
					        </tr>`)
			}
   		}
   		
     // ==============================================================
     // β¤οΈ ν¬μΈνΈ μ „μ²΄ κ°€μ Έμ¤κΈ° Ajax
       function myPointAjax(){
    	   $.ajax({
    		   url : '/my/myPointAjax',
    		   type : 'get',
    		   success : function(result){
    			   pointInfo = result;
    			   sortPoint(pointInfo);
    			   
    		   },
    		   error : function(err){
    			   console.log(err);
    		   }
    	   })
       }

	// ==============================================================
	// β¤οΈ ν¬μΈνΈ λ¶„λ¥ μ‘μ—…
       function sortPoint(points){
    	   points.forEach((point)=>{
    		   
    		   let pointMthd = point.pointMthd;
    		   let saveYmd = point.saveYmd;
    		   let usedYmd = point.usedYmd;
    		   
    		   pointTotal += point.point;

    		   // # ν¬μΈνΈ μ λ¦½ ν…μ΄λΈ”
    		   if(saveYmd!=null){
    			  saveCnt++;
    			   
    				// ## ν¬μΈνΈ μ λ¦½ λ°©λ²•μ— λ”°λΌ λ¶„λ¥
        		   switch(pointMthd){
        		   case 'μ¶μ„ν•κΈ°':
        			   attendPTotal += point.point;
        			   break;
        		   case 'κ±°λν›„κΈ°':
        			   dealPTotal += point.point;
        			   break;
        		   case 'λ¬΄λ£λ‚λ”':
        			   freePTotal += point.point;
        			   break;
        		   }
    				// ## ν™”λ©΄μ— κ·Έλ¦¬κΈ°
    			   makeSaveTable(point);
    			
  			   // # ν¬μΈνΈ μ‚¬μ© ν…μ΄λΈ”
    		   }else if(usedYmd != null){
    			   usedCnt++;
    			   usedTotal -= point.point;
    			   makeUsedTable(point);
    		   }
    	   })
    	   
    	   // # ν•©κ³„ μ¶λ ¥
    	   makeTotal();
    	   
    	   // # μ λ¦½/μ‚¬μ© ν¬μΈνΈ μ—†λ” κ²½μ°
    	   isNullCheck();

       }
	
   	// ==============================================================
   	// β¤οΈ ν¬μΈνΈ μ λ¦½/μ‚¬μ© λ‚΄μ—­μ΄ μ—†λ” κ²½μ°
		function isNullCheck(){
			if(saveCnt < 1){
				$(".saveTable").append(
						`<tr>
				           <td class="td-title-1">ν¬μΈνΈ μ λ¦½ λ‚΄μ—­μ΄ μ—†μµλ‹λ‹¤.</td>
				        </tr>`)
			}
			
			if(usedCnt < 1 ){
				$(".usedTable").append(
						`<tr>
				           <td class="td-title-1">ν¬μΈνΈ μ‚¬μ© λ‚΄μ—­μ΄ μ—†μµλ‹λ‹¤.</td>
				        </tr>`)
			}
			
			
		}
	
	// ==============================================================
	// β¤οΈ total λ¶€λ¶„ κ·Έλ¦¬κΈ°
	   function makeTotal(){
			$(".totalPTrgt").text(pointTotal);
			$(".attendPTrgt").text(attendPTotal);
			$(".dealPTrgt").text(dealPTotal);
			$(".freePTrgt").text(freePTotal);
			$(".usedPTrgt").text(usedTotal);
	   }
	
	// ==============================================================
     // β¤οΈ ν¬μΈνΈ μ λ¦½ λ‚΄μ—­ κ·Έλ¦¬κΈ°
       function makeSaveTable(pointInfo){
    	  $(".saveTable").append(
    		`
    		 <tr>
                <td class="td-title-1">[${pointInfo.pointMthd}] ${pointInfo.point}ν¬μΈνΈ μ λ¦½</td>
                <td class="td-title-2">${pointInfo.saveYmd}</td>
             </tr>
    		`	  
    	  )
    	  
       }

	// ==============================================================
	// β¤οΈ ν¬μΈνΈ μ‚¬μ© λ‚΄μ—­ κ·Έλ¦¬κΈ°
       function makeUsedTable(pointInfo){
		let usedPoint = (pointInfo.point).toString();
		usedPoint = usedPoint.substring(1);
    	  $(".usedTable").append(
    	   `
    	    <tr>
    	       <td class="td-title-1">[${pointInfo.pointMthd}] ${usedPoint}ν¬μΈνΈ μ‚¬μ© μ™„λ£</td>
    	       <td class="td-title-2">${pointInfo.usedYmd}</td>
    	    </tr>
    	    `	  
    	  )
       }
	

       </script>

	</div>


</body>
</html>