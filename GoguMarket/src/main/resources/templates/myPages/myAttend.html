<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://ultraq.net/thymeleaf/layout"
	layout:decorate="~{myPages/sideBar/sideBar}">
<head>
<style type="text/css">
#isTodayAttend span {
	color: #fd7e14;
	font-weight: bold;
}
</style>
<meta charset='utf-8' />
<script
	src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.4/index.global.min.js'></script>
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
</head>

<body>
	<div layout:fragment="myContent">
		<section id="page-content" class="page-wrapper section">
			<div class="about-section mb-80">
				<div class="container">
					<br>
					<div>
						<h4 class="blog-section-title border-left mb-30">ì¶œì„í•˜ê¸°</h4>
					</div>
					<div id="isTodayAttend"></div>
					<div id='calendar' style="width: 550px"></div>
					<div style="text-align: center; margin-right: 40%;">
						<button onclick="makeAttend()" id="attendBtn"
							class="submit-btn-1 mt-30 btn-hover-1"
							style="display: inline-block;">ì¶œì„í•˜ê¸°</button>
						<button onclick="goPoint()" id="attendBtn"
							class="submit-btn-1 mt-30 btn-hover-1">ë‚´ í¬ì¸íŠ¸ í™•ì¸í•˜ê¸°</button>
					</div>
				</div>
			</div>
		</section>
		
<script>

	// ==============================================================
	// â¤ï¸ ë³€ìˆ˜ ì„ ì–¸
		let date = new Date();

		let year = date.getFullYear();
		let month = ('0' + (date.getMonth() + 1)).slice(-2);
		let day = ('0' + date.getDate()).slice(-2);

		var today = year + '-' + month + '-' + day;
		
		var attendYn = false;
		var todayPoint = null;
		
	// ==============================================================
	// â¤ï¸ fullCalendar ê·¸ë¦¬ê¸°
		document.addEventListener('DOMContentLoaded', function() {
			let eventList = [];
			makeCal();

		});
		function makeCal() {
			var calendarEl = document.getElementById('calendar');
			var calendar = new FullCalendar.Calendar(calendarEl, {
				height : '500px',
				initialView : 'dayGridMonth',
				locale : 'ko',
				events : [

				$.ajax({
					type : "get",
					url : "/my/selectAttendList",
					success : function(result) {

						let aList = result.aList;

						for ( let i in aList) {
							calendar.addEvent({
								title : aList[i].point,
								start : aList[i].attendYmd,
								end : aList[i].attendYmd,
								display : 'background',
								backgroundColor : "#00b9ba",
								textColor : "black"
							})
						}
						//â–· ì˜¤ëŠ˜ ì¶œì„ì—¬ë¶€ ì²´í¬
						isAttendYn(result);
					}
				}) ]
			});
			calendar.render();

		}
		
	// ==============================================================
	// â¤ï¸ ì˜¤ëŠ˜ ì¶œì„ ì—¬ë¶€ í™•ì¸
		function isAttendYn(result) {
			let findToday = result.aList;
					console.log(findToday)
			for (i in findToday) {
				console.log(i)
				if (findToday[i].attendYmd == today) {
					todayPoint = findToday[i].point;
					attendYn = true;
					
				}
			}
					
			if(attendYn){
				$("#isTodayAttend").children().remove()
				$("#isTodayAttend").append(
						`
						<p>[ì¶œì„ì™„ë£ŒğŸ] ì˜¤ëŠ˜ì˜ ì¶œì„ í¬ì¸íŠ¸ëŠ” <span> ${findToday[i].point}</span>ì ì…ë‹ˆë‹¤!<p/>
						`		
						)
				$("#attendBtn").attr("disabled", "disabled").text("ì¶œì„ì™„ë£Œ")
			}else{
				$("#isTodayAttend").append(
						`
						<p>ğŸ ì¶œì„í•´ì„œ ì˜¤ëŠ˜ì˜ ëœë¤í¬ì¸íŠ¸ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”<p/>
						`
						)
					}
		}
	
	// ==============================================================
	// â¤ï¸ ì¶œì„í•˜ê¸°
		function makeAttend() {
			let confirmPlz = confirm("ì¶œì„í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")
			if (confirmPlz) {
				insertAttend();
			}
		}

	// ==============================================================
	// â¤ï¸ ì¶œì„í•˜ê¸° Ajax
		function insertAttend() {
			$.ajax({
				url : '/my/insertAttend/',
				type : 'get',
				dataType : 'json',
				contentType : 'application/json; charset = utf-8',
				success : function(aVO) {
					console.log(aVO);
					afterInsert(aVO);
				},
				error : function(err) {
					console.log(err);
				}
			})
		}

	// ==============================================================
	// â¤ï¸ ì¶œì„ í›„ í¬ì¸íŠ¸ ì•Œë¦¼
		function afterInsert(aVO) {
			console.log(aVO)
			alert("[ì¶œì„ì™„ë£Œ] " + aVO.point + " í¬ì¸íŠ¸ê°€ ì ë¦½ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰");
			makeCal();
		}

	// ==============================================================
	// â¤ï¸ ë§ˆì´í˜ì´ì§€ > í¬ì¸íŠ¸ í™•ì¸ìœ¼ë¡œ ì´ë™
		function goPoint(){
			location="/my/myPoint"
		}
	</script>
		
	</div>
</body>

</html>