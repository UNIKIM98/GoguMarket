<!doctype html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://ultraq.net/thymeleaf/layout"
	layout:decorate="~{layouts/layout}">

<head>
<meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>ì¤‘ê³ ê±°ë˜ìƒí’ˆìˆ˜ì •</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">


<style>
@font-face {
	font-family: 'S-CoreDream-3Light';
	src:
		url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_six@1.2/S-CoreDream-3Light.woff')
		format('woff');
	font-weight: normal;
	font-style: normal;
}

* {
	font-family: 'S-CoreDream-3Light';
}

#uploadFileList {
	width: 100%;
	height: 20%;
	padding: 10px;
	/* 		border: 1px solid lightgrey; */
	/* 		border-radius: 5px; */
	margin-bottom: 30px;
}

#uploadFileList:empty:before {
	content: attr(data-placeholder);
	color: #999;
	font-size: .9em;
}

.message-box input[type=text], textarea {
	width: 70%;
}

.message-box label {
	width: 25%;
}

#dFrm span{
	color : red;
}
</style>
<script src="https://code.jquery.com/jquery-3.6.3.js"
		integrity="sha256-nQLuAZGRRcILA+6dMBOvcRh5Pe310sBpanc6+QBmyVM="
		crossorigin="anonymous"></script>
</head>

<body>
	<div layout:fragment="content">
		<!-- Body main wrapper start -->
		<div class="wrapper" >
			<!-- Start page content -->
			<section id="page-content" class="page-wrapper section">

				<!-- MESSAGE BOX SECTION START -->
				<div class="message-box-section mb-80">
					<div class="container">
						<div class="row">
							<div class="col-lg-12" style="width: 70%">
								<div class="message-box box-shadow white-bg">
									<form id="dFrm" method="post" enctype="multipart/form-data" onsubmit="return false" th:each="d : ${dealInfo}">
										<div class="row">
											<div class="col-lg-12">
												<h4 class="blog-section-title border-left mb-30">êµ¬ë§¤ì˜ˆì•½</h4>
												<h5>êµ¬ë§¤ìì—ê²Œ ë³´ì—¬ì§ˆ í˜ì´ì§€ì…ë‹ˆë‹¤</h5>
												<h5>ì—…ë°ì´íŠ¸í˜ì´ì§€ì„. ì§ê±°ë˜ì¥ì†Œ/í¬ë§ê°€ê²©/prchs_id/stts="ì˜ˆì•½ì¤‘" ìœ¼ë¡œ ì—…ëƒí•˜ìƒ˜</h5>
											</div>
										</div>
										<div class="col-lg-10" id="inputFile">
											<label for="files">ìƒí’ˆì‚¬ì§„<span> *</span></label> 
											<input type="file" id="files" placeholder="ì²¨ë¶€íŒŒì¼" multiple="multiple">
											<br>
											<span id="fileErrMsg"></span>
											<div id="fileList">
												<div id="uploadFileList" data-placeholder='ğŸ¶ì²¨ë¶€íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤ğŸŒ³' 
													 class="message-box box-shadow white-bg"></div>
											</div>
										</div>
										<div>
											<table class="table">
													<tr>
														<th>ì¹´í…Œê³ ë¦¬</th>
														<td th:text="${d.ctgry}"></td>
													</tr>
													<tr>
														<th>ê¸€ì œëª©</th>
														<td th:text="${d.dlTtl}"></td>
													</tr>
													<tr>
														<th>ìƒí’ˆì„¤ëª…</th>
														<td th:text="${d.dlCn}"></td>
													</tr>
													<tr>
														<th>ìƒí’ˆê°€ê²©</th>
														<td th:text="${d.dlPrc}"></td>
											</table>
										</div>
										
										<div class="col-lg-10">
											<label for="area">ì§ê±°ë˜ì¥ì†Œ</label>
											<input type="text" name="area" id="area" placeholder="ì§ê±°ë˜ì¥ì†Œ" th:value=${d.area}>
										</div>
										<div class="col-lg-10">
											<!-- ë„¤ê³  y ì¸ ì‚¬ëŒì€ ê°€ê²© ì œì•ˆí•  ìˆ˜ ìˆë˜ë¡.. -->
											<label for="negoYn">ê°€ê²© ì œì•ˆ</label>
											<input type="text" name="dlPrc" id="dlPrc" placeholder="í¬ë§ê°€ê²©" th:value=${d.dlPrc}>
										</div>
										<div class="col-lg-12">
											<!-- ì˜ˆì•½ì´ë‹ˆê¹Œ í•¨ë” í™•ì¸í•˜ë¼ê¼¬ ê± ì ì–´ë´„ -->
											<label for="check">ì˜ˆì•½ ë‚´ìš©ì„ í™•ì¸í•˜ì…¨ìŠµë‹ˆê¹Œ?</label>
											<input type="checkbox" name="check" id="check" style="margin:0px">
										</div>
										<input type="hidden" name="dlNo" id="dlNo" th:value=${dealInfo.dlNo}>
										<input type="hidden" name="atchId" id="atchId" th:value=${atchList[0].atchId}>
										<input class="submit-btn-1 mt-30 btn-hover-1" type="submit" id="btnSave" role="button" value="êµ¬ë§¤ì˜ˆì•½í•˜ê¸°">
									</form>
								</div>
								<!-- </form> -->
							</div>
						</div>
					</div>
				</div>
			</section>
		</div>
	
	<script th:inline="javascript">
		//==============================================================================
		//ğŸ“Œ	 ê³µí†µë³€ìˆ˜ ì„ ì–¸ë¶€
			var fileCount = 0; //í˜„ì¬ ì²¨ë¶€íŒŒì¼ ê°œìˆ˜
			var totalCount = 10; // ì²¨ë¶€ ê°€ëŠ¥í•œ íŒŒì¼ ê°œìˆ˜
			var fileNum = 0; //ì²¨ë¶€íŒŒì¼ ì¸ë±ìŠ¤
			var inputFileList = new Array(); // insert íŒŒì¼ ë°°ì—´
			var deleteList = new Array(); // delete íŒŒì¼ ë°°ì—´
			var isSubmitOk = true; //submit ìœ íš¨ì„± ì²´í¬ boolean

			var img_style = 'width:100px;height:100px;z-index:none'; // ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€ ì†ì„±
			var exCnt = 0;
			
		//==============================================================================
		//ğŸ“Œ	 í•¨ìˆ˜ ì„ ì–¸ë¶€
		//âœ… DOM í•¨ìˆ˜
			$(function() {
				// ì²¨ë¶€íŒŒì¼ change
				$("#files").on("change", function(e) {
					$("#fileErrMsg").text("")
					inputFile(e);
				});
				
				// ì¹´í…Œê³ ë¦¬ change
				$("#cate").on("change", function(){
					$("#ctgryErrMsg").text("")
				})
				
				// form submit
				$("#btnSave").on("click", function() {
					formSubmit();
				});
				
				// ê¸°ì¡´ íŒŒì¼ë“¤ í™”ë©´ì— ë¿Œë ¤ì£¼ê¸°
				existingFiles();
			});
		

		//==============================================================================
		//âœ… ê¸°ì¡´ ì •ë³´ë“¤ í™”ë©´ì— ë¿Œë¦¬ê¸°(ì¹´í…Œê³ ë¦¬, ì‚¬ì§„, ë„¤ê³ ì—¬ë¶€)
			function existingFiles(){
			if(exCnt==0){
			/*<![CDATA[*/
				//1. ì¹´í…Œê³ ë¦¬
					let ctgry = /*[[ ${dealInfo.ctgry} ]]*/
					$("#cate option").val(ctgry).attr("selected",true);
			
				//2. ì‚¬ì§„
					var atchList = /*[[ ${atchList} ]]*/
					console.log(atchList.length>0);
				
					if(atchList.length>0){
						for(let idx in atchList){
							let atchId = atchList[idx].atchId;
							let atchNo = atchList[idx].atchNo;
							$('#uploadFileList').append(
														`<img style=${img_style} src=${atchList[idx].atchPath}
															   id=exFile${idx} onclick=deleteFile('exFile${idx}',${atchId},${atchNo})
															   class=m-1>`
														)
							fileCount++;
						}
					}
			
				//3. ë„¤ê³ ì—¬ë¶€(ì²´í¬ë°•ìŠ¤)
				let exNegoYn = /*[[ ${dealInfo.negoYn} ]]*/
				console.log(exNegoYn);
				
				if(exNegoYn=="Y"){
					$("#negoYn").attr("checked",true);
				}
				exCnt++;
				console.log(exCnt)
			/*]]*/
			}
			}
		
		//==============================================================================
		//âœ… ë¯¸ë¦¬ë³´ê¸° div / inputFileList ë°°ì—´ì— insert
			function inputFile(e) {
				var files = e.target.files;
				var filesArr = Array.prototype.slice.call(files);
				
				if (fileCount + filesArr.length > totalCount) {
					alert('íŒŒì¼ì€ ìµœëŒ€ ' + totalCount + 'ê°œê¹Œì§€ ì—…ë¡œë“œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
					return;
				} else {
					fileCount = fileCount + filesArr.length;
				}

				filesArr.forEach(function(f) {
					var reader = new FileReader();
					reader.onload = function(e) {
									inputFileList.push(f);
									$('#uploadFileList').append(
																`<img style=${img_style} src=${e.target.result}
																	   id=file${fileNum} onclick=fileDelete('file${fileNum}') class=m-1>`
																)
									fileNum++;
								};
					reader.readAsDataURL(f);
				});
				$("#files").val("");
			}

		//==============================================================================
		//âœ… ë¯¸ë¦¬ë³´ê¸° div / inputFileList ë°°ì—´ì—ì„œ delete	
			function fileDelete(fileNum) {
				var no = fileNum.replace(/[^0-9]/g, "");
				
				inputFileList[no].is_delete = true;
				$('#' + fileNum).remove();
				
				fileCount--;
				
				if(fileCount==0){
					$("#fileErrMsg").text("âœ… ìƒí’ˆ ì‚¬ì§„ì„ ë“±ë¡í•´ì£¼ì„¸ìš”.")
					isSubmitOk = false;
				}
			}
		
		//==============================================================================
		//âœ… exFile ì¤‘ì—ì„œ ì‚­ì œí•  íŒŒì¼ ì •ë³´ 
			function deleteFile(id, atchId, atchNo) {
				$("#"+id).remove();
				deleteList.push({
						"atchId": Number(atchId),
						"atchNo": Number(atchNo)  
					})
		}
		//==============================================================================
		//âœ… form submit
			function formSubmit() {
				// ì¹´í…Œê³ ë¦¬ val
				var ctgry = $("#cate option:selected").val(); 
				$("#ctgry").val(ctgry); 
				
				// ë„¤ê³ ì—¬ë¶€
				if ($('#negoYn').is(":checked")) {
		            $('#negoYn').val("Y");
		        }else{
		        	$('#negoYn').val("");
		        }
				
				// form submit ì „ ìœ íš¨ì„± ì²´í¬
				if(submitCheck()){
					var formData = new FormData($("#dFrm")[0]);
					// formData.append("deleteList", JSON.stringify(deleteList));

					for (var i = 0; i < inputFileList.length; i++) {
						if (!inputFileList[i].is_delete) {
							formData.append("files", inputFileList[i]);
						}
					}
					console.log(formData);
					// ê¸°ì¡´ íŒŒì¼ ì‚­ì œ ajax
					console.log(deleteList.length!=0)
					if(deleteList.length!=0){
						exFileDeleteAjax();
					}
					
					// ì‚­ì œí•  íŒŒì¼ ì—†ìœ¼ë©´ ìˆ˜ì • ajaxë§Œ ì‹¤í–‰
					$.ajax({	
						url : "/updateTestSubmit",
						type : "POST",
						data : formData,
						processData : false,
						contentType : false,
						success : function(result) {
							console.log(result)
							alert("[ìˆ˜ì •ì™„ë£Œ] ê²Œì‹œê¸€ ìˆ˜ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤ :D");
							location.href = "/goguma/dealMain";
						},
						error : function(err){
							alert("[ìˆ˜ì •ì‹¤íŒ¨] ê²Œì‹œê¸€ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤. :(");
						}
					});
				
				}
			}

		//==============================================================================
		//âœ… íŒŒì¼ ì‚­ì œ ajax
			function exFileDeleteAjax(){
				$.ajax({	
					url : "/deleteTest",
					type : "post",
					data :  JSON.stringify(deleteList),
					contentType: "application/json; charset=utf-8",
					success : function(delCnt) {
							console.log(delCnt)
					},
					error : function(err){
						alert("[ì‚­ì œì‹¤íŒ¨] ì²¨ë¶€íŒŒì¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤. :(");
					}
				});	
			}

		//==============================================================================
		//âœ… submit ì „ ìœ íš¨ì„± ì²´í¬
			function submitCheck(){
			//1. íŒŒì¼ ì—…ë¡œë“œ ì—¬ë¶€
			if($("#uploadFileList").children().length==0){
				$("#fileErrMsg").text("âœ… ìƒí’ˆ ì‚¬ì§„ì„ ë“±ë¡í•´ì£¼ì„¸ìš”.")
				isSubmitOk = false;
			}

			//2. ì¹´í…Œê³ ë¦¬ ì„ íƒ ì—¬ë¶€
			else if($("#ctgry").val()==""){
				$("#ctgryErrMsg").text("âœ… ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.")
				isSubmitOk = false;
			}

			//3. ê¸€ì œëª© ì‘ì„± ì—¬ë¶€
			else if($("#dlTtl").val()==""){
				$("#dlTtl").focus();
				isSubmitOk = false;
			}

			//4. ê¸€ë‚´ìš© ì‘ì„± ì—¬ë¶€
			else if($("#dlCn").val()==""){
				$("#dlCn").focus();
				isSubmitOk = false;
			}

			//5. ìƒí’ˆê°€ê²© ì‘ì„± ì—¬ë¶€
			else if($("#dlPrc").val()==""){
			   $("#dlPrc").focus();
				isSubmitOk = false;
			}
			
			else{
				isSubmitOk = true;
			}
			
			return isSubmitOk;			
		}			
	</script>
</div>


</body>

</html>