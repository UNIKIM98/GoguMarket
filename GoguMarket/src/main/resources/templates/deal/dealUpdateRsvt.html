<!doctype html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://ultraq.net/thymeleaf/layout"
	layout:decorate="~{layouts/layout}">

<head>
<meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>중고거래상품수정</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">


<style>
@font-face {
	font-family: 'S-CoreDream-3Light';
	src:
		url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_six@1.2/S-CoreDream-3Light.woff')
		format('woff');
	font-weight: normal;
	font-style: normal;
}

* {
	font-family: 'S-CoreDream-3Light';
}

#uploadFileList {
	width: 100%;
	height: 20%;
	padding: 10px;
	/* 		border: 1px solid lightgrey; */
	/* 		border-radius: 5px; */
	margin-bottom: 30px;
}

#uploadFileList:empty:before {
	content: attr(data-placeholder);
	color: #999;
	font-size: .9em;
}

.message-box input[type=text], textarea {
	width: 70%;
}

.message-box label {
	width: 25%;
}

#dFrm span{
	color : red;
}
</style>
<script src="https://code.jquery.com/jquery-3.6.3.js"
		integrity="sha256-nQLuAZGRRcILA+6dMBOvcRh5Pe310sBpanc6+QBmyVM="
		crossorigin="anonymous"></script>
</head>

<body>
	<div layout:fragment="content">
		<!-- Body main wrapper start -->
		<div class="wrapper" >
			<!-- Start page content -->
			<section id="page-content" class="page-wrapper section">

				<!-- MESSAGE BOX SECTION START -->
				<div class="message-box-section mb-80">
					<div class="container">
						<div class="row">
							<div class="col-lg-12" style="width: 70%">
								<div class="message-box box-shadow white-bg">
									<form id="dFrm" method="post" enctype="multipart/form-data" onsubmit="return false" th:each="d : ${dealInfo}">
										<div class="row">
											<div class="col-lg-12">
												<h4 class="blog-section-title border-left mb-30">구매예약</h4>
												<h5>구매자에게 보여질 페이지입니다</h5>
												<h5>업데이트페이지임. 직거래장소/희망가격/prchs_id/stts="예약중" 으로 업뎃하샘</h5>
											</div>
										</div>
										<div class="col-lg-10" id="inputFile">
											<label for="files">상품사진<span> *</span></label> 
											<input type="file" id="files" placeholder="첨부파일" multiple="multiple">
											<br>
											<span id="fileErrMsg"></span>
											<div id="fileList">
												<div id="uploadFileList" data-placeholder='🐶첨부파일이 없습니다🌳' 
													 class="message-box box-shadow white-bg"></div>
											</div>
										</div>
										<div>
											<table class="table">
													<tr>
														<th>카테고리</th>
														<td th:text="${d.ctgry}"></td>
													</tr>
													<tr>
														<th>글제목</th>
														<td th:text="${d.dlTtl}"></td>
													</tr>
													<tr>
														<th>상품설명</th>
														<td th:text="${d.dlCn}"></td>
													</tr>
													<tr>
														<th>상품가격</th>
														<td th:text="${d.dlPrc}"></td>
											</table>
										</div>
										
										<div class="col-lg-10">
											<label for="area">직거래장소</label>
											<input type="text" name="area" id="area" placeholder="직거래장소" th:value=${d.area}>
										</div>
										<div class="col-lg-10">
											<!-- 네고 y 인 사람은 가격 제안할 수 있또록.. -->
											<label for="negoYn">가격 제안</label>
											<input type="text" name="dlPrc" id="dlPrc" placeholder="희망가격" th:value=${d.dlPrc}>
										</div>
										<div class="col-lg-12">
											<!-- 예약이니까 함더 확인하라꼬 걍 적어봄 -->
											<label for="check">예약 내용을 확인하셨습니까?</label>
											<input type="checkbox" name="check" id="check" style="margin:0px">
										</div>
										<input type="hidden" name="dlNo" id="dlNo" th:value=${dealInfo.dlNo}>
										<input type="hidden" name="atchId" id="atchId" th:value=${atchList[0].atchId}>
										<input class="submit-btn-1 mt-30 btn-hover-1" type="submit" id="btnSave" role="button" value="구매예약하기">
									</form>
								</div>
								<!-- </form> -->
							</div>
						</div>
					</div>
				</div>
			</section>
		</div>
	
	<script th:inline="javascript">
		//==============================================================================
		//📌	 공통변수 선언부
			var fileCount = 0; //현재 첨부파일 개수
			var totalCount = 10; // 첨부 가능한 파일 개수
			var fileNum = 0; //첨부파일 인덱스
			var inputFileList = new Array(); // insert 파일 배열
			var deleteList = new Array(); // delete 파일 배열
			var isSubmitOk = true; //submit 유효성 체크 boolean

			
			
		//==============================================================================
		//📌	 함수 선언부
		//✅ DOM 함수
			$(function() {
				// 첨부파일 change
				$("#files").on("change", function(e) {
					$("#fileErrMsg").text("")
					inputFile(e);
				});
				
				// form submit
				$("#btnSave").on("click", function() {
					formSubmit();
				});
				
				// 기존 파일들 화면에 뿌려주기
				existingFiles();
			});
		

		//==============================================================================
		//✅ 기존 정보들 화면에 뿌리기(카테고리, 사진, 네고여부)
			function existingFiles(){
			if(exCnt==0){
				//2. 사진
					var atchList = /*[[ ${atchList} ]]*/
					console.log(atchList.length>0);
				
					if(atchList.length>0){
						for(let idx in atchList){
							let atchId = atchList[idx].atchId;
							let atchNo = atchList[idx].atchNo;
							$('#uploadFileList').append(
														`<img style=${img_style} src=${atchList[idx].atchPath}
															   id=exFile${idx} onclick=deleteFile('exFile${idx}',${atchId},${atchNo})
															   class=m-1>`
														)
							fileCount++;
						}
					}
			}
			}
		
		//==============================================================================
		//✅ 미리보기 div / inputFileList 배열에 insert
			function inputFile(e) {
				var files = e.target.files;
				var filesArr = Array.prototype.slice.call(files);
				
				if (fileCount + filesArr.length > totalCount) {
					alert('파일은 최대 ' + totalCount + '개까지 업로드 할 수 있습니다.');
					return;
				} else {
					fileCount = fileCount + filesArr.length;
				}

				filesArr.forEach(function(f) {
					var reader = new FileReader();
					reader.onload = function(e) {
									inputFileList.push(f);
									$('#uploadFileList').append(
																`<img style=${img_style} src=${e.target.result}
																	   id=file${fileNum} onclick=fileDelete('file${fileNum}') class=m-1>`
																)
									fileNum++;
								};
					reader.readAsDataURL(f);
				});
				$("#files").val("");
			}

		//==============================================================================
		//✅ 미리보기 div / inputFileList 배열에서 delete	
			function fileDelete(fileNum) {
				var no = fileNum.replace(/[^0-9]/g, "");
				
				inputFileList[no].is_delete = true;
				$('#' + fileNum).remove();
				
				fileCount--;
				
				if(fileCount==0){
					$("#fileErrMsg").text("✅ 상품 사진을 등록해주세요.")
					isSubmitOk = false;
				}
			}
		
		//==============================================================================
		//✅ form submit
			function formSubmit() {
				// form submit 전 유효성 체크
				if(submitCheck()){
					var formData = new FormData($("#dFrm")[0]);
					// formData.append("deleteList", JSON.stringify(deleteList));
					for (var i = 0; i < inputFileList.length; i++) {
						if (!inputFileList[i].is_delete) {
							formData.append("files", inputFileList[i]);
						}
					}
					console.log(formData);
					// 기존 파일 삭제 ajax
					
					// 삭제할 파일 없으면 수정 ajax만 실행
					$.ajax({	
						url : "/updateTestSubmit",
						type : "POST",
						data : formData,
						processData : false,
						contentType : false,
						success : function(result) {
							console.log(result)
							alert("[수정완료] 게시글 수정이 완료되었습니다 :D");
							location.href = "/goguma/dealMain";
						},
						error : function(err){
							alert("[수정실패] 게시글 수정 중 오류가 발생하였습니다. :(");
						}
					});
				}
			}

		//==============================================================================
		//✅ submit 전 유효성 체크
			function submitCheck(){
			//1. 파일 업로드 여부
			if($("#uploadFileList").children().length==0){
				$("#fileErrMsg").text("✅ 상품 사진을 등록해주세요.")
				isSubmitOk = false;
			}

			//2. 카테고리 선택 여부
			else if($("#ctgry").val()==""){
				$("#ctgryErrMsg").text("✅ 카테고리를 선택해주세요.")
				isSubmitOk = false;
			}

			//3. 글제목 작성 여부
			else if($("#dlTtl").val()==""){
				$("#dlTtl").focus();
				isSubmitOk = false;
			}

			//4. 글내용 작성 여부
			else if($("#dlCn").val()==""){
				$("#dlCn").focus();
				isSubmitOk = false;
			}

			//5. 상품가격 작성 여부
			else if($("#dlPrc").val()==""){
			   $("#dlPrc").focus();
				isSubmitOk = false;
			}
			
			else{
				isSubmitOk = true;
			}
			
			return isSubmitOk;			
		}			
	</script>
</div>


</body>

</html>