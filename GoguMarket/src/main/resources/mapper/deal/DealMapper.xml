<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.goguma.deal.mapper.DealMapper">
	
	<!-- 채은추가!! 확인후 주석은 지워주세욧 -->
	<select id="selectNtslDeal" 
			parameterType="String"
			resultType="map">
	SELECT d.* ,
		       (SELECT ATCH_PATH
	       		FROM ATCH
	       		WHERE ATCH_ID = d.ATCH_ID AND ROWNUM=1) ATCH_NM
                , m.atch_path profile, m.nick_nm nick_Nm, m.addr addr 
	FROM deal d JOIN MEM m 
    ON d.ntsl_Id = m.user_id
	WHERE ntsl_id = #{ntslId}
	</select>
	<!-- ====== ❤ new(getId+getAtch >> selectDealAtch ====== -->
	<select id="selectDealAtch" 
			parameterType="int" 
			resultType="com.goguma.common.vo.AtchVO">
	SELECT * FROM ATCH
	WHERE ATCH_ID = (SELECT atch_id FROM DEAL
	                WHERE dl_no = #{dlNo})
	</select>
	<!-- 	<select id="getId" -->
	<!-- 			resultType="String"> -->
	<!-- 	SELECT ATCH_ID -->
	<!-- 			FROM DEAL -->
	<!-- 			WHERE DL_NO = #{dlNo} -->
	<!-- 	</select> -->

	
	<!-- ====== ❤ getDeal >> selectDeal ======= -->
	<select id="selectDeal"
			parameterType="int"
			resultType="DealVO">
	SELECT *FROM DEAL
	WHERE DL_NO = #{dlNo}
	</select>

	<!-- ======= 판매자정보(현재 게시글 제외) ======== -->
	<select id="getDealSeller"
			parameterType="DealVO"
			resultType="DealVO">			                
		SELECT d.* ,
		       (SELECT ATCH_PATH
	       		FROM ATCH
	       		WHERE ATCH_ID = d.ATCH_ID AND ROWNUM=1) ATCH_NM
		FROM deal d
		WHERE dl_no != ${dlNo}
		  AND ntsl_id = (	SELECT ntsl_id
		                    FROM deal
		                    WHERE dl_no = ${dlNo})
	</select>
	
	<!-- ======= 카테고리 정보======== -->
	<select id="getDealCtgry" parameterType="DealVO" resultType="DealVO">			                
		SELECT  d.* ,
		       (SELECT ATCH_PATH
	       		FROM ATCH
	       		WHERE ATCH_ID = d.ATCH_ID AND ROWNUM=1) ATCH_NM
		FROM deal d
		WHERE dl_no != ${dlNo}
		  AND ctgry = (	SELECT ctgry
		                    FROM deal
		                    WHERE dl_no = ${dlNo})
	</select>

	<!-- deal 리스트 셀렉트(페이징) -->
	<select id="dealListSelect" 
			parameterType="com.goguma.deal.vo.DealSearchVO"
			resultType="com.goguma.deal.vo.DealVO">
	select * 
			from (select rownum rn,a.* from(
			SELECT d.* ,
		       (SELECT ATCH_PATH
	       		FROM ATCH
	       		WHERE ATCH_ID = d.ATCH_ID AND ROWNUM=1) ATCH_NM 
			FROM DEAL d
			<include refid="creiteria"></include>
		<if test="orderby != null and orderby != ''" >
			order by ${orderby} desc
		</if>
		<if test="orderby == null " >
			order by dl_ymd desc
		</if>
	<![CDATA[
		) a where rownum <= #{last} )b where rn >= #{first}
		]]>	
	</select>
	 
	<sql id="creiteria">
		<where>
			<if test="ctgry != null and ctgry != ''" >
				ctgry = #{ctgry}
			</if>
			 <if test="searchTtl != null and searchTtl != ''">
            <choose>
                <!-- 검색 유형이 있을 때 -->
                <when test="searchType != null and searchType != ''">
                    <choose>
                        <when test="'dlTtl'.equals(searchType)">
                            AND dl_ttl LIKE '%' || #{searchTtl}|| '%'
                        </when>
                        <when test="'dlCn'.equals(searchType)">
                            AND dl_cn LIKE '%' || #{searchTtl}|| '%'
                        </when>
                        <when test="'ntslId'.equals(searchType)">
                            AND ntsl_id LIKE '%' || #{searchTtl}|| '%'
                        </when>
                    </choose>
                </when>
                <!-- 전체 검색일 때 때 -->
                <otherwise>
                    AND (
                           dl_Ttl LIKE '%' || #{searchTtl}|| '%'
                        OR dl_Cn LIKE '%' || #{searchTtl}|| '%'
                        OR ntsl_Id LIKE '%' || #{searchTtl}|| '%'
                    )
                </otherwise>
            </choose>
        </if>
		</where>
	</sql>
	
	<select id="getcountTotal" 
			resultType="int">
		SELECT COUNT(*)
		FROM DEAL
		<include refid="creiteria"></include>

	</select>
	
	<!-- 게시글 작성 -->
	<insert id="insertDeal"
			parameterType="com.goguma.deal.vo.DealVO">
		<selectKey keyProperty="dlNo" resultType="int"
			order="BEFORE">
			SELECT
			CASE WHEN MAX(dl_no) IS NULL THEN 1 ELSE
			MAX(dl_no) + 1 END as dlNo
			FROM deal
		</selectKey>		
		INSERT INTO DEAL (DL_NO, 
		           DL_TTL, 
		           DL_CN, 
		           CTGRY,
				   DL_YMD, 
				   DL_PRC, 
				   AREA, 
				   NTSL_ID,
				   ATCH_ID
						<if test="negoYn != null">,NEGO_YN</if>) 
			VALUES (#{dlNo}, 
			        #{dlTtl}, 
			        #{dlCn}, 
			        #{ctgry},
					CURRENT_DATE, 
					#{dlPrc}, 
					#{area}, 
					#{ntslId},
					#{atchId}
						<if test="negoYn != null">,#{negoYn}</if>)	
	</insert>
	
	<!-- 게시글 삭제 -->
	<insert id="deleteDeal"
			parameterType="string">
		DELETE FROM DEAL
		WHERE DL_NO = #{dlNo}
	</insert>
	
	<!-- 게시글 수정 -->
	<update id="updateDeal"
			parameterType="com.goguma.deal.vo.DealVO">
		UPDATE DEAL
		SET 
			 DL_TTL= #{dlTtl},
			 DL_CN = #{dlCn},
			 CTGRY = #{ctgry},
			 DL_YMD = CURRENT_DATE,
			 DL_PRC = #{dlPrc},
			 AREA = #{area}
			<if test="negoYn != null">,NEGO_YN = #{negoYn}</if>
		WHERE DL_NO = #{dlNo}
	</update>
	
	<update id="dealHitUpdate"
			parameterType="int">
		UPDATE DEAL
		SET INQ_CNT = INQ_CNT + 1
		WHERE DL_NO = #{dlNo}
	</update>
	
	
</mapper>