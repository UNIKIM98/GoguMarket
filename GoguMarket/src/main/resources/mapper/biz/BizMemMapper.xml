<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.goguma.biz.mapper.BizMemMapper">

	<!-- 가게목록 전체조회 -->
	<select id="getBizList" resultType="com.goguma.biz.vo.BizMemVO">
		select * from biz_mem
	</select>
	
	<!-- 개별조회(가게상세페이지) -->
	<select id="bizInfo" parameterType="String"
		resultType="com.goguma.biz.vo.BizMemVO">
		SELECT *
		FROM biz_mem
		WHERE biz_no = #{bizNo}
	</select>


	<!-- 가게목록 페이징(전체조회) -->
	<select id="bizListPage"
		parameterType="com.goguma.biz.vo.BizSearchVO" resultType="BizMemVO">
		select * from(select rownum rn, a.* from(
						SELECT *
						FROM biz_mem
						<include refid="criteria"></include>
						order by biz_no
		<![CDATA[
		) a where rownum <= #{last} ) b where rn >= #{first}
		]]>
	</select>

	<!-- 반복 쿼리문 -->
	<sql id="criteria">
		<where>
			<if test="keyword != null and keyword != ''">
				<choose>
					<when test="searchType != null and searchType != ''">
						<choose>
							<when test="'bizNm'.equals(searchType)">
								AND biz_nm LIKE '%' || #{keyword}|| '%'
							</when>
						</choose>
					</when>
				</choose>
			</if>
		</where>
	</sql>

	<!-- 가게리스트 갯수 카운팅(페이징용) -->
	<select id="bizListCnt" parameterType="BizSearchVO"
		resultType="int">
		select count(*)
		from biz_mem
		<!-- <include refid="creiteria"></include> -->

	</select>

	<!-- 단골 수 카운팅 -->
	<select id="BizDangolCnt" resultType="com.goguma.biz.vo.BizMemVO">
		SELECT count(d.dg_no) dCount, m.biz_no
		FROM biz_dangol d RIGHT JOIN biz_mem m
				ON d.biz_no = m.biz_no
				GROUP BY d.biz_no,  m.biz_no
				ORDER BY biz_no
	</select>
	
	<!-- 리뷰 수 카운팅 -->
	<select id="BizReviewCnt" resultType="com.goguma.biz.vo.BizMemVO">
		SELECT count(rw.res_rv_no) rwCount, m.biz_no
		FROM rsvt_rv rw JOIN rsvt r
                        ON rw.rsvt_no = r.rsvt_no
                        RIGHT JOIN biz_mem m
                        ON r.biz_no = m.biz_no
				GROUP BY r.biz_no,  m.biz_no
	</select>

	<!-- 가게정보 첨부파일 -->
	<select id="bizImgList" resultType="com.goguma.biz.vo.BizMemVO">
		SELECT b.*,
		(SELECT atch_path
        	FROM atch a 
                WHERE b.atch_id = a.atch_id
                AND ROWNUM = 1) atch_path
		FROM biz_mem b
		ORDER BY b.biz_no
	</select>


</mapper>